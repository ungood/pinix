#!/usr/bin/env bash
set -euo pipefail

PINIX_ROOT="$(cd "$(dirname "$0")" && pwd)"
SESSION_NAME="${1:-pinix}"

# Ensure we're in the nix dev shell
if [ -z "${IN_NIX_SHELL:-}" ]; then
    exec nix develop "${PINIX_ROOT}" --command env IN_NIX_SHELL=1 "$0" "$@"
fi

# If already inside the tmux session, just attach
if [ -n "${TMUX:-}" ]; then
    echo "Already inside tmux. Use 'tmux switch-client -t ${SESSION_NAME}' to switch." >&2
    exit 1
fi

# Create or attach to the session
if tmux has-session -t "${SESSION_NAME}" 2>/dev/null; then
    exec tmux attach-session -t "${SESSION_NAME}"
else
    exec tmux new-session -s "${SESSION_NAME}" -c "${PINIX_ROOT}" "pi"
fi
